@model Expense_Tracker.Models.Transaction

@{
    ViewData["PageTitle"] = Model.TransactionId == 0 ? "Crear nueva transacción" : "Editar transacción";
    var username = Context.Request.Query["username"].ToString() ?? "Guest";
    var categories = ViewBag.Categories as List<Expense_Tracker.Models.Category>;
}

<div class="row">
    <div class="col-md-7">
        <div class="widget p-5" style="background-color:#212b36">
            <form asp-action="AddOrEdit" method="post">
                <input type="hidden" name="TransactionId" value="@Model.TransactionId" />
                <input type="hidden" name="username" value="@username" />

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="mb-3">
                    <label for="date" class="form-label">Fecha</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary flatpickr-date" 
                           id="date" name="Date" value="@Model.Date.ToString("dd/MM/yyyy")" 
                           placeholder="Seleccionar fecha" />
                </div>
                <div class="mb-3">
                    <label for="CategoryId" class="form-label">Categoría</label>
                    <select class="form-select bg-dark text-white border-secondary" 
                            id="CategoryId" name="CategoryId">
                        @if (categories != null)
                        {
                            @foreach (var category in categories)
                            {
                                if (category.CategoryId == Model.CategoryId)
                                {
                                    <option value="@category.CategoryId" selected>@category.TitleWithIcon</option>
                                }
                                else
                                {
                                    <option value="@category.CategoryId">@category.TitleWithIcon</option>
                                }
                            }
                        }
                    </select>
                    <span asp-validation-for="CategoryId" class="text-danger fs-6"></span>
                </div>

                <div class="mb-3">
                    <label for="amount" class="form-label">Monto</label>
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-white border-secondary">$</span>
                        <input type="number" class="form-control bg-dark text-white border-secondary" 
                               id="amount" name="Amount" value="@Model.Amount" 
                               min="0" placeholder="0" />
                    </div>
                    <span asp-validation-for="Amount" class="text-danger fs-6"></span>
                </div>
                <div class="mb-3">
                    <label for="NoteInput" class="form-label">Nota</label>
                    <textarea class="form-control bg-dark text-white border-secondary" 
                              id="NoteInput" name="Note" rows="3" 
                              placeholder="Nota">@Model.Note</textarea>
                </div>
                <button type="submit" class="btn btn-success">Enviar</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Flatpickr with Spanish locale
        flatpickr(".flatpickr-date", {
            dateFormat: "d/m/Y",
            locale: "es",
            defaultDate: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Date.ToString("dd/MM/yyyy")))
        });

        // Keyword to category mapping for auto-suggestion
        const keywordMap = {
            // 🍔 Food & Dining
            'comida': 'Food',
            'pizza': 'Food',
            'hamburguesa': 'Food',
            'sandwich': 'Food',
            'despensa': 'Food',
            'supermercado': 'Food',
            'snacks': 'Food',
            'restaurante': 'Food',
            'almuerzo': 'Food',
            'cena': 'Food',
            'desayuno': 'Food',
            'café': 'Food',
            'food': 'Food',

            // 🚍 Travel & Transport
            'camión': 'Travel',
            'metro': 'Travel',
            'vuelo': 'Travel',
            'avión': 'Travel',
            'uber': 'Travel',
            'didi': 'Travel',
            'taxi': 'Travel',
            'gasolina': 'Travel',
            'combustible': 'Travel',
            'boleto': 'Travel',
            'travel': 'Travel',
            'transporte': 'Travel',

            // 🏠 Housing & Utilities
            'renta': 'Housing',
            'casa': 'Housing',
            'departamento': 'Housing',
            'mantenimiento': 'Housing',
            'electricidad': 'Housing',
            'luz': 'Housing',
            'agua': 'Housing',
            'gas': 'Housing',
            'wifi': 'Housing',
            'internet': 'Housing',
            'teléfono': 'Housing',
            'housing': 'Housing',

            // 🛍 Shopping
            'compras': 'Shopping',
            'mall': 'Shopping',
            'ropa': 'Shopping',
            'vestido': 'Shopping',
            'zapatos': 'Shopping',
            'amazon': 'Shopping',
            'mercadolibre': 'Shopping',
            'shopping': 'Shopping',

            // 💊 Health & Medical
            'hospital': 'Health',
            'doctor': 'Health',
            'medicina': 'Health',
            'farmacia': 'Health',
            'consulta': 'Health',
            'salud': 'Health',
            'seguro': 'Health',
            'health': 'Health',

            // 🎬 Entertainment
            'película': 'Entertainment',
            'netflix': 'Entertainment',
            'prime': 'Entertainment',
            'spotify': 'Entertainment',
            'música': 'Entertainment',
            'juego': 'Entertainment',
            'cine': 'Entertainment',
            'entretenimiento': 'Entertainment',
            'entertainment': 'Entertainment',

            // 💼 Income
            'salario': 'Income',
            'bono': 'Income',
            'pago': 'Income',
            'depósito': 'Income',
            'ingreso': 'Income',
            'reembolso': 'Income',
            'freelance': 'Income',
            'proyecto': 'Income',
            'income': 'Income',

            // 🎓 Education
            'escuela': 'Education',
            'universidad': 'Education',
            'curso': 'Education',
            'clase': 'Education',
            'examen': 'Education',
            'libros': 'Education',
            'colegiatura': 'Education',
            'education': 'Education',

            // 🎁 Miscellaneous
            'regalo': 'Other',
            'donación': 'Other',
            'boda': 'Other',
            'fiesta': 'Other',
            'other': 'Other'
        };


        document.getElementById('NoteInput').addEventListener('input', function(e) {
            const noteText = e.target.value.toLowerCase();
            let suggestedCategory = null;

            // Find the last matching keyword in the note
            for (const keyword in keywordMap) {
                if (noteText.includes(keyword)) {
                    suggestedCategory = keywordMap[keyword];
                }
            }

            const categoryDropdown = document.getElementById('CategoryId');

            if (suggestedCategory) {
                // Look for matching category in dropdown
                const options = categoryDropdown.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].text.toLowerCase().includes(suggestedCategory.toLowerCase())) {
                        categoryDropdown.value = options[i].value;
                        
                        // Flash effect
                        categoryDropdown.classList.add('flash-highlight');
                        setTimeout(() => categoryDropdown.classList.remove('flash-highlight'), 800);
                        break;
                    }
                }
            }
        });
    </script>

    <style>
        /* Simple flash effect when auto-select happens */
        .flash-highlight {
            border: 2px solid #28a745 !important;
            box-shadow: 0 0 8px #28a745;
        }
    </style>
}
