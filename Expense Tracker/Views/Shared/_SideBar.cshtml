@*
    Sidebar for Expense Tracker
*@

@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    var username = ViewContext.HttpContext.Request.Query["username"].ToString();
    // Get the current user's first name
    var currentUser = await UserManager.GetUserAsync(User);
    var userFirstName = currentUser?.FirstName ?? "Invitado";
}

<!-- Sidebar -->
<div id="sidebar" class="sidebar-open">
    <div class="logo-wrapper">
        <div class="app-logo">
            <img src="~/logo.png" />
        </div>
        <div class="w-100"></div>
        <i id="sidebar-toggler" class="fa-solid fa-angles-left"></i>
    </div>

    <div class="profile-wrapper">
        <img class="profile-pic" src="~/DefaultPhoto.jpeg" />
        <div class="titles d-flex flex-column ps-3">
            <h6 class="mb-0">Wallet App</h6>
            @if (User.Identity != null && User.Identity.IsAuthenticated)
            {
                <span class="text-muted" id="UserNameSideBar">@userFirstName</span>
            }
            else
            {
                <span class="text-muted">Invitado</span>
            }
        </div>
    </div>

    <!-- Menu Navigation -->
    <nav class="sidebar-menu">
        <div class="menu-section-title">General</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/Dashboard/Index?username=@username">
                    <i class="fa-solid fa-box me-2"></i>
                    <span class="menu-text">Panel</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/Category/Index?username=@username">
                    <i class="fa-solid fa-folder-closed me-2"></i>
                    <span class="menu-text">Categorías</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/Transaction/Index?username=@username">
                    <i class="fa-solid fa-arrow-right-arrow-left me-2"></i>
                    <span class="menu-text">Transacciones</span>
                </a>
            </li>
        </ul>
        
        <div class="menu-section-title mt-4">Extras</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="javascript:confirmAndSendReportEmail();">
                    <i class="fa-solid fa-chart-simple me-2"></i>
                    <span class="menu-text">Reportes</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Logout Form -->
    <div class="mt-auto p-3 logout-wrapper">
        <form asp-controller="Account" asp-action="Logout" method="post">
            <button type="submit" class="btn btn-danger w-100">
                <i class="fa-solid fa-right-from-bracket"></i> <span class="menu-text">Cerrar Sesión</span>
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sidebar toggle
        var sidebar = document.getElementById('sidebar');
        var toggler = document.getElementById('sidebar-toggler');
        
        toggler.onclick = function () {
            sidebar.classList.toggle('sidebar-open');
            sidebar.classList.toggle('sidebar-closed');
            document.body.classList.toggle('sidebar-is-closed');
            
            if (sidebar.classList.contains('sidebar-closed')) {
                toggler.classList.remove('fa-angles-left');
                toggler.classList.add('fa-angles-right');
            } else {
                toggler.classList.remove('fa-angles-right');
                toggler.classList.add('fa-angles-left');
            }
        };
    });

    function confirmAndSendReportEmail() {
        // Get the current user's first name from the sidebar text for the confirmation message
        const userFirstName = document.getElementById('UserNameSideBar').textContent;

        // Show a confirmation dialog
        if (confirm(`¿Está seguro de que desea enviar el reporte a ${userFirstName}?`)) {
            // User clicked "OK"
            sendReportRequest();
        }
    }

    function sendReportRequest() {
        // Get the anti-forgery token from the hidden input we added to the layout
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        // Show some feedback to the user
        alert("Enviando reporte... Esto puede tomar un momento.");

        // Use the Fetch API to make a secure POST request to our controller action
        fetch('/Dashboard/SendReportEmail', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': token // Send the token in the headers
            }
        })
        .then(response => response.json())
        .then(data => {
            // Show the result from the server in an alert
            alert(data.message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error inesperado. Por favor, inténtelo de nuevo.');
        });
    }
</script>