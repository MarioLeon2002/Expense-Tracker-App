@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["isDashboard"] = true;
    
    // Get chart data from ViewBag
    var doughnutData = ViewBag.DoughnutChartData as IEnumerable<dynamic>;
    var splineData = ViewBag.SplineChartData as IEnumerable<dynamic>;
    var recentTransactions = ViewBag.RecentTransactions as IEnumerable<Expense_Tracker.Models.Transaction>;
    
    // Prepare doughnut chart data for JSON serialization
    var doughnutLabels = doughnutData?.Select(d => (string)d.categoryTitleWithIcon).ToList() ?? new List<string>();
    var doughnutAmounts = doughnutData?.Select(d => (int)d.amount).ToList() ?? new List<int>();
    
    // Prepare spline chart data for JSON serialization
    var splineDays = splineData?.Select(d => (string)d.day).ToList() ?? new List<string>();
    var splineIncome = splineData?.Select(d => (int)d.income).ToList() ?? new List<int>();
    var splineExpense = splineData?.Select(d => (int)d.expense).ToList() ?? new List<int>();
}

@*Summary Widgets*@
<div class="row mb-4">
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary income">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3">
                <span class="lead">Ingresos Totales</span>
                <h1 class="display-6 fw-bold">@ViewBag.TotalIncome</h1>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary expense">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3">
                <span class="lead">Gastos Totales</span>
                <h1 class="display-6 fw-bold">@ViewBag.TotalExpense</h1>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="d-flex flex-row widget summary balance">
            <div class="d-flex flex-column justify-content-center p-5">
                <i class="fa-solid fa-dollar-sign fa-2xl"></i>
            </div>
            <div class="d-flex flex-column m-auto py-3">
                <span class="lead">Balance</span>
                <h1 class="display-6 fw-bold">@ViewBag.Balance</h1>
            </div>
        </div>
    </div>
</div>

@*Doughnut and Spline Chart with Chart.js*@
<div class="row mb-4">
    <div class="col-md-4">
        <div class="widget chart">
            <div class="p-4">
                <h5 class="fw-bold">Gastos por Categoría</h5>
            </div>
            <div class="p-3" style="height: 350px;">
                <canvas id="doughnutChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="widget chart">
            <div class="p-4">
                <h5 class="fw-bold">Ingresos vs Gastos</h5>
            </div>
            <div class="p-3" style="height: 350px;">
                <canvas id="splineChart"></canvas>
            </div>
        </div>
    </div>
</div>

@* Recent Transactions with DataTables *@
<div class="row">
    <div class="col-md-12">
        <div class="widget">
            <div class="p-4">
                <h5 class="fw-bold">Transacciones Recientes</h5>
            </div>
            <div class="px-4 pb-4">
                <table id="recentTransactionsTable" class="table table-dark table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Categoría</th>
                            <th>Nota</th>
                            <th>Fecha</th>
                            <th class="text-end">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (recentTransactions != null)
                        {
                            @foreach (var transaction in recentTransactions)
                            {
                                <tr>
                                    <td>@transaction.CategoryTitleWithIcon</td>
                                    <td>@transaction.Note</td>
                                    <td>@transaction.Date.ToString("dd/MM/yyyy")</td>
                                    <td class="text-end">@transaction.FormattedAmount</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Chart colors palette
        const chartColors = ['#0e8d76','#a4b219','#cb9b00','#8a442c','#0454b5','#7d0a0a','#822690','#4c2090','#313e93','#0096ac'];
        
        // Mexican Peso formatter
        const mxnFormatter = new Intl.NumberFormat('es-MX', { 
            style: 'currency', 
            currency: 'MXN',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        
        // Doughnut Chart
        const doughnutLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(doughnutLabels));
        const doughnutAmounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(doughnutAmounts));
        
        if (doughnutLabels.length > 0) {
            const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
            new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: doughnutLabels,
                    datasets: [{
                        data: doughnutAmounts,
                        backgroundColor: chartColors.slice(0, doughnutLabels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#fff',
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + mxnFormatter.format(context.parsed);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Spline/Line Chart
        const splineDays = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(splineDays));
        const splineIncome = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(splineIncome));
        const splineExpense = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(splineExpense));
        
        const splineCtx = document.getElementById('splineChart').getContext('2d');
        new Chart(splineCtx, {
            type: 'line',
            data: {
                labels: splineDays,
                datasets: [{
                    label: 'Ingresos',
                    data: splineIncome,
                    borderColor: '#54ffa9',
                    backgroundColor: 'rgba(84, 255, 169, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false
                }, {
                    label: 'Gastos',
                    data: splineExpense,
                    borderColor: '#ffe91a',
                    backgroundColor: 'rgba(255, 233, 26, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#fff' }
                    },
                    y: {
                        grid: { 
                            color: '#32414d',
                            borderDash: [3, 5]
                        },
                        ticks: { 
                            color: '#fff',
                            callback: function(value) {
                                return mxnFormatter.format(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: '#fff',
                            font: { size: 14 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + mxnFormatter.format(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
        
        // DataTables initialization for recent transactions
        $(document).ready(function() {
            $('#recentTransactionsTable').DataTable({
                paging: false,
                searching: false,
                info: false,
                ordering: false,
                language: {
                    emptyTable: "No hay transacciones recientes"
                }
            });
        });
    </script>
}